---
title: WavePci 设备的硬件要求
description: WavePci 设备的硬件要求
keywords:
- WavePci 硬件要求 WDK 音频
- 总线主 WDK 音频
- 任意对齐 WDK 音频
- 内存 WDK 音频
- 缓存 WDK 音频
- 数据复制 WDK 音频
- 复制音频数据
- 缓冲 WDK 音频
- 拆分 buffer 帧 WDK 音频
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: ad2debfd9451886ba9362afbce8eb5ffe7085126
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96784781"
---
# <a name="hardware-requirements-for-wavepci-devices"></a>WavePci 设备的硬件要求


## <span id="hardware_requirements_for_wavepci_devices"></span><span id="HARDWARE_REQUIREMENTS_FOR_WAVEPCI_DEVICES"></span>


选择新硬件设计的功能时，供应商应遵循以下通用原则：

-   供应商应该将每项功能的成本与它对性能的影响进行权衡，而不是尝试只将所有处理转移到硬件。

-   考虑硬件功能的潜在价值时，供应商应评估该功能对系统整体的影响，而不是将焦点放在特定子系统（如音频）上。

-   通过在硬件中选择要加速的功能，供应商可以减轻 CPU 工作负荷并提高内存使用率，从而使更多的系统资源可供其他任务使用。

过去，并非所有音频硬件设计都已遵循这些原则。

播放音频内容或混合多个流时，某些 WDM 音频驱动程序会不必要地消耗大量 CPU 时间和总线带宽。 此类缺陷通常是硬件设计有缺陷，驱动程序实现效率低下。 硬件设计缺陷还可以防止音频驱动程序处理某些波形格式或需要软件干预的必要解决方法。

WaveCyclic 设备模型的目的是为了适应较旧音频设备的硬件限制。 新硬件设计应该与 WavePci 完全兼容。

可执行真正散播/聚集 DMA 的 WavePci 设备无需占用 CPU，就能在缓冲区之间复制音频数据。 与 WaveCyclic 不同，WavePci 不需要数据复制，使其成为 multistream 或硬件加速音频设备的首选小型端口驱动程序。 设计良好的 WavePci 设备应该几乎不会消耗 CPU 资源，这样就可以将大量音频流 (64 或更多的) 发送到硬件进行三维处理和混合。

WavePci 设备需要支持散播/聚集 DMA 传输的总线主控 DMA 控制器。 硬件设计不应对 DMA 控制器可以处理的数据传输类型施加任意限制。 WavePci 设备应满足以下要求：

-   **设备必须是总线主机。**

    它应该能够在不干预操作系统的情况下自主访问系统内存，也不使用系统 DMA 资源。

-   **设备必须能够处理任意长度的数据传输。**

    它应处理映射 (参见 [**IPortWavePciStream：： GetMapping**](/windows-hardware/drivers/ddi/portcls/nf-portcls-iportwavepcistream-getmapping)) 大于内存页。 例如，传输限制为 4 kb 的设备不符合 WavePci 的全部要求。 在支持 Microsoft Windows 的64位 Cpu 上，页的大小为 8 kb，这使得某些映射的大小可能大于 4 kb。 从理论上讲，在单个映射中超过 32 kb 的数据传输可能会根据物理内存碎片而发生。 在另一种极端情况下，可能会有一个字节的映射大小。

-   **设备应处理与系统内存中任何位置之间的数据传输。**

    跨 32 kb 或更大的2个边界的数据传输很有可能。 一台计算机现在可以包含 4 gb 以上的 RAM，在这些系统中，在64位 CPU 或 x86 物理地址扩展 (PAE) 的情况下，这些映射在物理内存中可能大于 4 gb。 若要在这些计算机上实现最佳性能，供应商应创建支持64位寻址的设备。 否则，需要在软件中复制数据。 对于在 RAM 超过 16 mb 的系统上进行24位寻址的设备，数据复制一直是必需的。 如果设备不能在物理内存中的任何位置读取或写入，则应使用 WaveCyclic 而不是 WavePci。 驱动程序可以在设备启动时做出此决定 (请参阅 [**IRP \_ MN \_ START \_ device**](../kernel/irp-mn-start-device.md)) ，确定其地址是否足以访问系统内存总线的完整地址范围。

-   **设备应处理任意对齐的数据传输。**

    映射可以在内存中的任意字节边界开始和结束。 可以在映射之间拆分音频数据帧，并在第一个映射结束时的前几个通道的示例中进行拆分，并在第二个映射中拆分其他通道的示例。 有关示例，请参阅 [波形筛选器](wave-filters.md)。 对于某些示例大小，甚至可以在映射之间拆分示例容器。 如果设备要求传输必须位于缓存行边界上，或者设备要求传输严格与音频帧边界对齐 (例如，假设传输大小分别分为四个，则在立体声16位事例) 中，此设备不足以满足完整的 WavePci 合规性。 请注意，通过限制驱动程序所公开的数据范围或格式 (例如，仅特定的比特率或仅) 某些通道配置，可以将不符合要求的硬件作为 WavePci 设备公开。

与前面的列表中的最后一个点相关，WavePci 设备的散播/聚集 DMA 引擎应处理跨内存页边界的缓冲区。 例如，一个包含10毫秒16位的16位 PCM 音频样本（适用于 5.1 48）的缓冲区的大小如下：

 (6 示例/帧) \* (2 个字节/示例) \* (48K 帧/秒)  (\* 10 毫秒) = 5760 字节

这超出了内存页面大小 (4096 字节) ，这意味着缓冲区包含一个或两个页面边界，具体取决于它在内存中的位置。 该缓冲区包含一个整数数字 (480) 的音频数据帧，但是其中一个或两个框架可能跨页面边界。

出于此原因，WavePci 设备的散点/集合 DMA 硬件应设计用于处理音频帧 (如下图中的帧 197) ，在内存中两个物理上不连续的页面之间拆分。

![说明相对于页面起始位置的音频缓冲区的关系图](images/framealign.png)

上图的顶部是一个5760字节的缓冲区，跨越两个页面之间的边界。 在此示例中，缓冲区从第一页的起始处开始以1728字节的偏移量开始，这会将缓冲区的开头与内存中的64字节边界对齐。 假设每个音频帧占用12个字节，并且包含六个通道。 第一页包含所有帧0到196，但仅包含帧197的前四个字节。

该图的底部是音频帧197的详细视图，其中显示第一页中只有通道0和1的示例。 第2步到第5通道的示例包含在第二页中。

尽管这两个页面在图形顶部彼此相邻显示，但实际上它们只在内核虚拟内存中是连续的。 由于包含缓冲区的页面在物理内存中是不连续的，因此使用物理地址的散点/集合 DMA 控制器必须将缓冲区的两个部分指定为其传输队列中的两个单独条目。 WavePci 端口驱动程序会在页面边界自动将缓冲区拆分为两个单独的物理映射。

即使前面的示例发生了更改以使缓冲区与第一页的起始处保持一致，但拆分框架问题不会消失。 下图演示了这一点。 在这种情况下，框架341会在页面边界处拆分，并在第一页中再次处理第2通道和第1页的示例，并在第二页找到第2和第5通道的示例。

![说明与页面开头对齐的音频缓冲区的关系图](images/framealign2.png)

散播/聚集 DMA 控制器无法正确处理拆分音频帧的 WavePci 设备会受到它可以处理的音频数据格式的种类限制，不过，软件解决方法可能有助于缓解一些硬件设计缺陷。 有关详细信息，请参阅 [WavePci 滞后时间](wavepci-latency.md)。

 

