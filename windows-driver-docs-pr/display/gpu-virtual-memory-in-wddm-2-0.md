---
title: WDDM 2.0 中的 GPU 虚拟内存
description: 本部分提供有关 GPU 虚拟内存的详细信息，包括进行更改的原因以及驱动程序将如何使用这些更改。
ms.date: 06/20/2019
ms.localizationpriority: medium
ms.openlocfilehash: b2834eb1d12c810762d2447d51ff26861893effe
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96825745"
---
# <a name="gpu-virtual-memory-in-wddm-20"></a>WDDM 2.0 中的 GPU 虚拟内存

本部分提供有关 GPU 虚拟内存的详细信息，包括进行更改的原因以及驱动程序将如何使用这些更改。 从 Windows 10 开始，此功能可用。

## <a name="introduction"></a>简介

在 Windows 显示器驱动程序模型 (WDDM) v1. x 下， (DDI) 生成设备驱动程序接口，以使图形处理单元 (GPU) 引擎应通过分段物理地址引用内存。 在应用程序之间共享段并提交时，资源会在其生存期内重新定位，并会更改其分配的物理地址。 这将导致需要跟踪命令缓冲区内的内存引用（通过分配和修补位置列表），并在提交到 GPU 引擎之前，使用正确的物理内存引用修补这些缓冲区。 这种跟踪和修补会消耗大量资源，实质上是计划模型，在该模型中，视频内存管理器必须检查每个数据包，然后才能将它提交到引擎。

随着更多的硬件供应商转向基于硬件的计划模型，其中的工作直接从用户模式提交到 GPU，并且 GPU 管理各种不同的工作队列，在提交到 GPU 引擎之前，必须消除视频内存管理器检查和修补每个命令缓冲区的需要。

为实现此目的，WDDM v2 支持 GPU 虚拟寻址。 在此模型中，为每个进程分配一个唯一的 GPU 虚拟地址空间，其中每个要在其中执行的 GPU 上下文。 分配由进程创建或打开，在该进程的 GPU 虚拟地址空间中分配唯一的 GPU 虚拟地址，该地址空间在分配的生存期内保持不变并且唯一。 这允许用户模式驱动程序通过其 GPU 虚拟地址引用分配，而不必担心基础物理内存在其生存期内发生变化。

GPU 的各个引擎可在物理或虚拟模式下运行。 在物理模式下，计划模型将保持与与 WDDM v1. x 相同。 在物理模式下，用户模式驱动程序将继续生成 "分配" 和 "修补程序位置" 列表。 它们按命令缓冲区提交，并用于在提交到引擎之前，将命令缓冲区修补到实际的物理地址。

在虚拟模式下，引擎通过 GPU 虚拟地址引用内存。 在此模式下，用户模式驱动程序直接从用户模式生成命令缓冲区，并使用新服务向内核提交这些命令。 在此模式下，用户模式驱动程序不会生成分配或修补程序位置列表，尽管它仍负责管理分配的驻留。 有关驱动程序驻留的详细信息，请参阅 [WDDM 2.0 中的驱动程序驻留](driver-residency-in-wddm-2-0.md)。

## <a name="gpu-memory-models"></a>GPU 内存模型

WDDM v2 支持用于 GPU 虚拟寻址、 *GpuMmu* 和 *IoMmu* 的两个不同的模型。 驱动程序必须选择支持这两个模型中的一个或两个。 单个 GPU 节点可以同时支持这两种模式。

### <a name="gpummu-model"></a>GpuMmu 模型

在 *GpuMmu* 模型中，视频内存管理器管理 GPU 内存管理单元和基础页表，并向用户模式驱动程序公开服务，以允许它管理到分配的 GPU 虚拟地址映射。 GpuMmu 表示 GPU 使用 GPU 页面表来访问数据。 页面表可能指向系统内存或本地设备内存。

有关详细信息，请参阅 [GpuMmu model](gpummu-model.md)。

### <a name="iommu-model"></a>IoMmu 模型

在 *IoMmu* 模型中，CPU 和 GPU 共享公用地址空间和 CPU 页表。 在这种情况下，只能访问系统内存，因此，IoMmu 适用于集成 Gpu。 IoMmu 提供了一个更简单的编程模型，在该模型中，GPU 和 CPU 可以使用同一个指针来访问内存。 无需在 GPU 可访问的内存中管理一组单独的页表。 也就是说，由于地址转换和管理的开销，IoMmu 模型可能会导致性能下降。

有关详细信息，请参阅 [IoMmu 模型](iommu-model.md)。
