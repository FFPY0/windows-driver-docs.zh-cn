---
title: 系统分页进程
description: 大多数分页操作都在系统分页过程的上下文中发生。 唯一的例外是 UpdateGpuVirtualAddress 回调中的页表更新，它在一个特殊的伴随上下文中发生，并在同步呈现时出现。
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 14d8b71f650e27607ef8b2ed330f4486d02292eb
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96839579"
---
# <a name="system-paging-process"></a>系统分页进程


大多数分页操作都在系统分页过程的上下文中发生。 唯一的例外是 [*UpdateGpuVirtualAddress 回调*](/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_updategpuvirtualaddresscb)中的页表更新，它在一个特殊的伴随上下文中发生，并在同步呈现时出现。

Microsoft DirectX graphics 内核使用系统分页过程来执行分页操作，例如：

-   在系统和本地图形处理单元之间传输分配 (GPU) 内存
-   用模式填充分配
-   更新页表
-   将分配映射到孔径段
-   刷新翻译外观缓冲区

分页过程有自己的 GPU 虚拟地址空间、GPU 上下文和直接内存访问 (DMA) 缓存 (称为分页缓冲区) 。 它有自己的页表，它们固定在物理内存中并且仅在电源转换期间逐出。

分页进程的虚拟地址空间具有预定义的布局，在适配器初始化期间进行初始化，并在每次出现电源转换后的内存内容丢失时进行初始化。

![虚拟和物理地址空间](images/system-paging-process.1.png)

DirectX 图形内核在根页表中初始化足够多的页表和页表项，以涵盖 1 GB 的虚拟地址空间。 空闲区用于在传输和填充操作过程中对分页进程虚拟地址空间进行临时映射分配。 如果分配不适合虚拟地址暂存区，则传输操作将以区块完成。

将为分页过程创建系统根页表分配。 它的内容是在初始化过程中设置的，在电源转换) 后 (例外。

系统进程的页表分为两部分：

系统将创建一个 *系统页表，该表* 将 *暂存区页表* 反射到系统进程的地址空间中。 这允许系统进程在必要时从草稿区修改暂存区页面和映射/取消映射内存。 页表的内容是在适配器初始化期间设置的，永远不会发生更改。
*草稿区域页* 表项用于将分配映射到分页进程的虚拟地址空间。 它们在初始化期间初始化为 *无效* ，以后用于分页操作。
分页过程的页表在适配器初始化和开机事件期间通过 [*UpdatePageTable*](./dxgkddiupdatepagetable.md) 分页操作进行初始化。 对于这些操作， **PageTableUpdateMode** 强制使用 cpu **\_ 虚拟** ，并且必须使用 cpu 立即完成， (不应) 使用分页缓冲。

所有其他进程的页表项的更新都是使用驱动程序指定的 **PageTableUpdateMode** 来完成的。 这些更新在分页过程的上下文中完成。

下面是设置的完成方式：

1.  将创建一个根页表分配和较低级别的页表分配，以涵盖 1 GB 的地址空间。
2.  分配被提交到内存段。
3.  将多个 [*UpdatePageTable*](./dxgkddiupdatepagetable.md) 分页操作发出给驱动程序，以初始化页表项。

作为分页进程虚拟地址空间初始化的示例，让我们考虑以下参数：

-   页面大小为4096字节
-   分页进程虚拟地址空间为 1 GB
-   页面表条目大小为4个字节

在此示例中，我们需要一个由以下项组成的2级翻译方案：

-   一个系统根页表
-   一个系统页表
-   255草稿区域页表

下图显示了如何根据根页表的位置和物理内存中的页表初始化页表。 请注意，物理地址仅作为说明提供。
页表包含 4 MB 的地址空间。 因此，系统页表涵盖了所有草稿区域页表。 草稿区域从 4 MB 虚拟地址开始。

正如您所看到的，从0到4095的虚拟地址范围将无效。

![页表初始化](images/system-paging-process.2.png)

 

