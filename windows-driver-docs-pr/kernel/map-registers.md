---
title: 映射寄存器
description: 映射寄存器
keywords:
- 内存管理 WDK 内核，映射寄存器
- 地图注册 WDK 内核
- 虚拟地址空间映射 WDK 内核
- 逻辑地址空间映射 WDK 内核
- 物理地址空间映射 WDK 内核
- 映射内存
- 地址空间映射 WDK 内核
- 散点/收集功能 WDK 内核
- 转换地址空间 WDK 内核
- 内存管理 WDK 内核，映射地址
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 842ae917fa57984a8efa5e5dabd7204b3f8dfd09
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96823983"
---
# <a name="map-registers"></a>映射寄存器





执行 DMA 的驱动程序使用三个不同的地址空间，如下图所示。

![物理、逻辑和虚拟地址映射](images/3addrspc.png)

在任何 Windows 平台上，驱动程序都可以访问处理器支持的完整虚拟地址空间。 在32位处理器上，虚拟地址空间表示四个 gb。 CPU 使用页面表将虚拟地址空间中的地址转换为系统的物理地址空间中的地址。 每个页表项 (PTE) 将一页虚拟内存映射到物理内存页，并在必要时导致分页操作。 MDL (内存描述符列表) 为与驱动程序 DMA 操作相关联的缓冲区提供类似的映射。

设备访问系统的完整虚拟地址空间的能力有所不同。 设备使用逻辑 (设备) 地址空间中的地址。 每个 HAL 使用 *映射寄存器* 将设备或逻辑地址转换为物理地址 (物理 RAM) 中的位置。 对于设备硬件，映射寄存器执行 MDL (和页面表) 为软件 (驱动程序) 执行的相同功能：将地址转换为物理内存。

由于这些地址空间分别寻址，驱动程序不能使用虚拟地址空间中的指针来寻址物理内存中的位置，反之亦然。 驱动程序必须首先将虚拟地址转换为物理地址。 同样，设备不能使用逻辑地址直接访问物理内存。 设备必须首先转换地址。

HAL 必须为不同计算机上的各种 DMA 设备和 i/o 总线设置支持 DMA 的适配器对象。 例如，大多数 ISA DMA 控制器、从属设备和总线主控设备都没有足够的地址行来访问32位处理器的完整的 4 gb 系统物理地址空间 (或36位 PAE 模式下运行的 x86 处理器的 64-千兆字节系统物理地址) 。 与此相反，PCI DMA 设备通常具有足够多的地址行来访问32位处理器中的完整系统物理地址空间。 因此，每个 HAL 都提供 DMA 设备可以访问的 *逻辑地址* 范围与每台计算机的 *物理地址* 范围之间的映射。

每个适配器对象与一个或多个映射寄存器相关联，具体取决于要传输的数据量和可用内存量。 在 DMA 传输过程中，HAL 使用每个映射寄存器将设备辅助性逻辑页的别名转换为 CPU 中的物理内存页。 实际上，映射寄存器为使用 DMA 的驱动程序提供了散播/聚集支持，而不管它们的设备是否具有散点/收集功能。

### <a href="" id="address-mapping-for-a-sample-isa-dma-device"></a>

下图说明了不具有分散/收集功能的 ISA DMA 设备的驱动程序的物理到逻辑地址映射。

![示例 isa dma 设备的地址映射](images/3dmapreg.png)

上图显示了以下类型的映射：

1.  每个地图寄存器会将一系列物理地址映射 (由实线) 指向低序位逻辑地址 (点线) 用于 ISA DMA 设备。

    此处，三个映射寄存器用于将系统物理内存中三个分页数据的范围别名为 ISA DMA 设备的3个页面大小的低序位逻辑地址范围。

2.  在 DMA 操作期间，ISA 设备使用映射的逻辑地址来访问系统内存。

    对于适用的 PCI DMA 设备，三个映射寄存器还将用于三页大小的数据区域。 但是，映射的逻辑地址范围并不一定与相应的物理地址范围相同，因此 PCI 设备还会使用逻辑地址来访问系统内存。

3.  MDL 中的每个条目将虚拟地址空间中的一个位置映射到一个物理地址。

请注意，映射寄存器和 MDL 中的虚拟到物理条目之间的对应关系：

-   每个映射寄存器和一个 MDL 中的每个虚拟条目都映射到一个完整的数据页，以便进行 DMA 传输操作。

-   每个映射寄存器和一个 MDL 中的每个虚拟条目都可能映射到的数据量小于整页。 例如，MDL 中的初始虚拟条目可以映射到物理页面边界的偏移，如前面的 **物理、逻辑和虚拟地址映射** 图所示。

-   每个映射寄存器和一个 MDL 中的每个虚拟条目至少一个字节。

在请求读取或写入操作的 IRP 中， **&gt; MdlAddress** 中的不透明到驱动程序 MDL 中的每个虚拟条目都代表用户缓冲区的系统物理内存中的页面边界。 同样，单个 DMA 传输所需的每个附加映射寄存器都表示可由设备访问的逻辑地址范围中化名为系统物理内存的页面边界。

在每个 Windows 平台上，每个适配器对象都有一个关联的集合，其中包含一个或多个映射寄存器，它们位于特定于平台的 (和不透明到驱动程序) 基址。 从驱动程序的角度来看，显示 [示例 ISA DMA 设备的地址映射](#address-mapping-for-a-sample-isa-dma-device) 的图中显示的地图寄存器基本是一组映射寄存器的句柄，可以是芯片、系统 DMA 控制器或总线主适配器中的硬件寄存器，甚至还可以是在系统内存中创建 HAL 的虚拟寄存器。

对于不同的设备和 Windows 平台，可用于适配器对象的映射寄存器的数目可能会有所不同。 例如，由于不同 Windows 平台上的 DMA 控制器具有不同的功能，HAL 可以使更多的映射寄存器可用于在某些平台上使用系统 DMA 的驱动程序。

 

 




