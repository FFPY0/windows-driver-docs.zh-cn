---
title: 多处理器防护
description: 多处理器防护
keywords:
- 多处理器安全 WDK 内核
- 对称多处理器平台 WDK 内核
- SMP WDK 内核
- 旋转锁定 WDK 内核
- 同步 WDK 内核，多处理器安全
- 对称平台 WDK 内核
- 锁定 WDK 内核
- 死锁 WDK 内核
- 关键部分例程 WDK 内核
- 共享数据保护 WDK 内核
- 调度程序对象 WDK 内核，多处理器安全
- 内核调度程序对象 WDK，多处理器安全
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: ef6086964e2ae8aaa9747e319012ead5d150c8e9
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96838011"
---
# <a name="multiprocessor-safe"></a>多处理器防护





基于 Microsoft Windows NT 的操作系统旨在统一地在单处理器和对称多处理器 (SMP) 平台上运行，并且应将内核模式驱动程序设计为与此类似。

在任何 Windows 多处理器平台上，都存在以下情况：

-   所有 Cpu 都是相同的，并且任何一个或全部处理器都必须具有相同的协处理器。

-   所有 Cpu 共享内存并对内存具有统一的访问权限。

-   在 *对称* 平台中，每个 CPU 都可以访问内存、采用中断，以及访问 i/o 控制寄存器。 与此相反，在 *非对称* 多处理器计算机中，一个 CPU 使用一组从属 cpu 的所有中断。 )  (

为了安全地在 SMP 平台上运行，操作系统必须保证在一个处理器上执行的代码不会同时访问和修改另一个处理器正在访问和修改的数据。 例如，如果最低级别驱动程序的 ISR 正在处理一个处理器上的设备中断，则它必须对设备寄存器或关键的驱动程序定义数据具有独占访问权限，以防其设备同时中断另一个处理器。

此外，在单处理器计算机中序列化的驱动程序 i/o 操作可以在 SMP 计算机中重叠。 也就是说，处理传入 i/o 请求的驱动程序例程可以在一个处理器上执行，而与设备通信的另一个例程同时在另一个处理器上执行。 无论内核模式驱动程序是在单处理器还是对称多处理器计算机上执行，它们都必须同步对驱动程序例程之间共享的任何驱动程序定义的数据或系统提供的资源的访问权限，并同步对物理设备的访问（如果有）。

Windows NT 内核组件导出一种称为 [旋转锁](./introduction-to-spin-locks.md)的同步机制，驱动程序可使用该机制来保护共享数据 (或设备寄存器) 从同时在对称多处理器平台上运行的一个或多个例程同时访问。 内核强制执行有关使用旋转锁的两个策略：

-   在任意给定时刻，只能有一个例程持有特定的自旋锁。 在访问共享数据之前，必须引用数据的每个例程必须首先尝试获取数据的旋转锁。 若要访问相同的数据，另一个例程必须获取旋转锁，但在当前持有者释放该锁之前，无法获取旋转锁。

-   内核为系统中的每个自旋锁分配一个 IRQL 值。 仅当例程在自旋锁的分配 IRQL 上运行时，内核模式例程才能获取特定的自旋锁。

这些策略可防止驱动程序例程通常在较低的 IRQL 下运行，但目前持有一个自旋锁，而该锁由较高优先级的驱动程序例程（尝试获得相同的自旋锁）抢占。 因此，避免死锁。

分配给自旋锁的 IRQL 通常是可以获取旋转锁的最高 IRQL 例程。

例如，最低级别驱动程序的 ISR 经常与驱动程序的 DPC 例程共享状态区域。 DPC 例程调用驱动程序提供的 *关键部分* 例程来访问共享区域。 保护共享区域的自旋锁的 IRQL 等于设备中断的 DIRQL。 只要关键部分例程持有自旋锁并访问 DIRQL 上的共享区域，ISR 就不能在单处理器或 SMP 计算机上运行。

-   ISR 无法在单处理器计算机上运行，因为设备中断被屏蔽，如 [Always Preemptible 和 Always 中断](always-preemptible-and-always-interruptible.md)中所述。

-   在 SMP 计算机中，ISR 无法获取保护共享数据的自旋锁，而临界部分例程包含自旋锁并访问 DIRQL 上的共享数据。

一组内核模式线程可以通过等待某个内核的调度程序对象来同步对共享数据或资源的访问：事件、mutex、信号量、计时器或其他线程。 但是，大多数驱动程序并不会设置自己的线程，因为它们可以在避免线程上下文切换时获得更好的性能。 每当时间关键内核模式支持例程和驱动程序以 IRQL = 调度 \_ 级别或在 DIRQL 运行时，它们必须使用内核的自旋锁来同步对共享数据或资源的访问。

有关详细信息，请参阅 [自旋锁](./introduction-to-spin-locks.md)、 [管理硬件优先级](managing-hardware-priorities.md)和 [内核调度程序对象](./introduction-to-kernel-dispatcher-objects.md)。

 

