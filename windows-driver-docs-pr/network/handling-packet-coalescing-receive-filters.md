---
title: 处理数据包合并接收筛选器
description: 处理数据包合并接收筛选器
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 8612427752a08a0c5239fca77b848f520b934f61
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96839485"
---
# <a name="handling-packet-coalescing-receive-filters"></a>处理数据包合并接收筛选器


通过 oid [ \_ 接收 \_ 筛选器 \_ 集 \_ 筛选器](./oid-receive-filter-set-filter.md)的 oid 方法请求，将多个接收筛选器下载到微型端口驱动程序。 每个筛选器都可以指定一个或多个测试 (的 *标头字段测试*) ，网络适配器使用该测试来确定是否应将接收的数据包合并到适配器上的硬件合并缓冲器中。

在微型端口驱动程序将网络适配器配置为接收筛选器之前，驱动程序应根据适配器的硬件功能优化接收筛选器。 例如，所有接收筛选器都需要 MAC 标头的标头字段测试。 因此，该驱动程序可以根据此测试的结果优化筛选规则。 这允许适配器确定哪些开放系统互连 (OSI) 第3层 (L3) 和第4层 (L4) 

一旦网络适配器配置了接收筛选器，它就必须执行以下操作：

-   对于所接收的数据包，特定筛选器的所有标头字段测试参数必须匹配，以便合并合并缓冲区中的数据包。

    网络适配器将接收筛选器的所有标头字段测试的结果与逻辑 AND 运算组合在一起。 也就是说，如果接收筛选 [**器的 NDIS \_ 接收 \_ 筛选器 \_ 字段 \_ 参数**](/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_receive_filter_field_parameters) 结构中包含的任何标头字段测试失败，则接收的数据包不满足指定的筛选条件，并且不能合并。

-   网络适配器仅根据指定的标头字段测试参数检查数据包数据。 适配器必须忽略未指定标头字段测试的数据包中的所有标头字段。

-   如果接收的数据包匹配任何接收筛选器的所有标头字段测试，则网络适配器必须在硬件合并缓冲区中合并数据包。 合并第一个数据包后，网络适配器必须启动硬件计时器，并将过期时间设置为匹配接收筛选器的 [**NDIS \_ 接收 \_ 筛选器 \_ 参数**](/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_receive_filter_parameters)结构的 **MaxCoalescingDelay** 成员的值。

-   随着接收到与数据包合并接收筛选器匹配的数据包，网络适配器将其放入合并缓冲区。

    如果硬件计时器已在运行，则适配器不得停止或重新启动匹配接收筛选器的计时器。 但是，适配器可以配置具有匹配接收筛选器的最小过期值的硬件计时器。 例如，当驱动程序收到与接收筛选器 *X* 匹配的数据包时，适配器将使用该接收筛选器的指定过期值启动计时器。 如果适配器接收到与接收筛选器 *Y* 匹配的数据包，则适配器可以使用该接收筛选器的指定过期值重新配置硬件计时器。

    **注意**  如果计时器上的剩余时间小于接收筛选器的过期时间，则网络适配器不得重新配置硬件计时器。

     

-   一旦接收的数据包合并，网络适配器就会在发生以下任何事件时生成中断：

    -   如果硬件合并缓冲区中的可用空间达到硬件特定的低水位线，网络适配器必须生成接收中断，使微型端口驱动程序能够处理合并的接收数据包。

    -   如果用于硬件合并缓冲区的硬件定时器过期，网络适配器必须生成接收中断，以便微型端口驱动程序能够处理合并的接收数据包。

    -   如果清除了接收筛选器并合并了与筛选器相匹配的数据包，网络适配器必须生成接收中断，以便微型端口驱动程序可以处理合并的接收数据包。

    -   如果接收的数据包与任何接收筛选器都不匹配，网络适配器必须生成接收中断，以便微型端口驱动程序可以处理收到的数据包。 如果已合并任何数据包，则微型端口驱动程序还必须处理这些数据包。

    -   如果网络适配器为除接收中断之外的任何其他中断状态生成中断，网络适配器还必须发出接收中断状态信号，以便微型端口驱动程序可以处理合并的已接收数据包。

    一旦产生中断，网络适配器必须停止硬件定时器（如果它尚未过期），并必须清除硬件合并缓冲区。

微型端口驱动程序必须维护合并的数据包计数器，该计数器包含与数据包合并筛选器匹配的已接收数据包数的值。 NDIS 通过 oid [ \_ 数据包 \_ 合并 \_ 筛选器 \_ 匹配 \_ 计数](./oid-packet-coalescing-filter-match-count.md)的 oid 查询请求来查询此计数器。

网络适配器仅在硬件以全功能状态运行时才执行数据包合并。 当硬件处于低功耗状态时，适配器必须仅基于唤醒模式筛选收到的数据包，这些模式已通过 oid [ \_ PNP \_ ENABLE ENABLE \_ 唤醒 \_ 启用](./oid-pnp-enable-wake-up.md)。

当网络适配器转换为完全电源状态时，微型端口驱动程序必须执行以下步骤：

-   微型端口驱动程序必须将网络适配器配置为丢弃硬件合并缓冲区内所有合并的数据包。 网络适配器在转换为低功耗状态时可能已合并了这些数据包。

-   微型端口驱动程序必须将网络适配器配置为在低功耗转换之前下载到驱动程序的一组数据包合并接收筛选器。

-   微型端口驱动程序必须清除合并的数据包计数器。

 

