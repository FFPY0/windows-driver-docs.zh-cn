---
title: 网络适配器中的性能
description: 决定在网络适配器上实现哪些硬件功能时，始终需要进行权衡。
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 1a0bff90849feae31ee8997d05a124f47f83f129
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96822861"
---
# <a name="performance-in-network-adapters"></a>网络适配器中的性能


决定在网络适配器上实现哪些硬件功能时，始终需要进行权衡。 考虑添加允许中断裁决的任务卸载功能、对硬件进行动态优化、提高 PCI 总线的使用和支持巨型帧，这一点越来越重要。 这对于将在需要高性能的配置中使用的高端网络适配器尤其重要。

-   [支持 TCP 和 IP 校验和卸载](#supporting-tcp-and-ip-checksum-offload)
-   [支持大规模发送卸载 (LSO) ](#supporting-large-send-offload-lso)
-   [ (IPSec) 卸载支持 IP 安全](#supporting-ip-security-ipsec-offload)
-   [提高中断裁决](#improving-interrupt-moderation)
-   [有效使用 PCI 总线](#using-the-pci-bus-efficiently)
-   [支持巨型帧](#supporting-jumbo-frames)

## <a name="supporting-tcp-and-ip-checksum-offload"></a>支持 TCP 和 IP 校验和卸载


对于最常见的网络流量，将校验和计算卸载到网络适配器硬件，可减少每个字节所需的 CPU 周期数，从而提高性能。 校验和计算是网络堆栈中最昂贵的功能，原因有两个：

-   它可为长路径长度提供。
-   这会导致缓存改动效果 (通常在发送方) 上。

通过减少主机 CPU 上的负载并提高缓存效率，将校验和计算卸载到发送方可以提高系统的整体性能。

在 Windows 性能实验室中，如果在网络密集型工作负荷中卸载了校验和，我们已测量了19% 的 TCP 吞吐量改进。 对此改进的分析表明，总改善的11% 是因为路径长度减少，而8% 是由于增加了缓存的有效性。

在接收方上卸载校验和与在发送方上分担校验和具有相同的优点。 在同时充当客户端和服务器的系统（如套接字代理服务器）上，可以查看更多权益。 在 CPU 不一定繁忙的系统（如客户端系统）上，可能会在更好的网络响应时间内查看卸载校验和的好处，而不是明显提高吞吐量。

## <a name="supporting-large-send-offload-lso"></a>支持大规模发送卸载 (LSO) 


Windows 为网络适配器/驱动程序提供了更大的最大段大小播发 (MSS) 的最大段大小。 这允许 TCP 将最大为64K 的缓冲区分配给驱动程序，该驱动程序将较大的缓冲区划分为网络 MTU 内容纳的数据包。

TCP 分段工作是由网络适配器/驱动程序硬件而不是主机 CPU 来完成的。 如果网络适配器的 CPU 能够处理额外的工作，则会显著提高性能。

对于经过测试的许多网络适配器，当主机 CPU 比网络适配器硬件更强大时，纯粹的网络活动会出现少许改善。 但是，对于典型的业务工作负荷，已测量最多9% 吞吐量的总体系统性能改进，因为主机 CPU 使用其大部分循环来执行事务。 在这些情况下，将 TCP 分段卸载到硬件会使主机 CPU 从分段负载中释放出来，从而实现更多事务的额外循环。

## <a name="supporting-ip-security-ipsec-offload"></a> (IPSec) 卸载支持 IP 安全


Windows 提供了向网络适配器硬件卸载 IPSec 加密工作的功能。 加密（尤其是3个 DES (也称为三重 DES) ）的周期/字节比率非常高。 因此，将 IPSec 卸载到网络适配器硬件并不是很奇怪，因为在安全的 Internet 和 VPN 测试中，性能提升了30%。

## <a name="improving-interrupt-moderation"></a>提高中断裁决


一个简单的网络适配器会在数据包到达时在主机上生成硬件中断，或在数据包发送请求完成后发出信号。 中断延迟和生成的缓存改动效果增加了总体网络性能。 在许多情况下 (例如，系统使用情况或大量网络流量) ，最好通过处理每个中断的多个数据包来降低硬件中断的成本。

利用大量网络工作负载，吞吐量的性能提高最多为9%，吞吐量的提高率已在网络密集型工作负荷上测量。 但是，仅针对吞吐量改进优化中断裁决参数可能会导致响应时间的性能下降。 若要维护最佳设置并适应不同的工作负荷，最好允许动态调整的参数，如本文后面的自动优化中所述。

## <a name="using-the-pci-bus-efficiently"></a>有效使用 PCI 总线


网络适配器硬件性能中最重要的因素之一是使用 PCI 总线的效率。 此外，网络适配器的 DMA 性能会影响同一 PCI 总线上的所有 PCI 卡的性能。 优化 PCI 使用情况时，必须考虑以下准则：

-   通过在适当的位置聚合目标页面，简化 DMA 传输。

-   通过在较大的块中执行 DMA 来减少 PCI 协议开销， (至少 256) 字节。 如果可能，则对数据流进行时间，以便在单个 PCI 事务中传输整个数据包。 不过，请考虑如何进行转移。 例如，在开始传输之前，不要等待所有数据到达，因为等待将增加延迟并占用额外的缓冲空间。

-   最好使用额外的字节来填充 DMA 数据包传输，而不需要通过传输数据包的最后几个字节来额外额外传输到 "清理"。

-   根据 PCI 规范的建议，使用内存读取、内存读取行和内存读取多个事务。

-   网络适配器总线接口硬件应检测主机内存控制器中的限制，并相应地调整行为。 例如，网络适配器总线接口硬件应检测 DMA 内存读取的内存控制器预提取限制，并等待一小段时间，然后重试事务。 硬件应检测到网络适配器部分的重试次数过多，并增加了主机上的第一次重试以后事务的时间。 当你确信它仍忙于获取下一顺序的数据集时，不会继续向内存控制器提交事务。

-   最大程度地减少等待状态的插入，在数据传输过程中尤其如此。 更好的做法是，如果要插入多个或两个等待状态，则更好的做法是，如果要插入多个等待状态，请使用总线来完成总线并等待另一个 PCI 适配器。

-   使用内存映射 i/o 而不是程控 i/o。 这也适用于驱动程序。

## <a name="supporting-jumbo-frames"></a>支持巨型帧


支持 (Mtu) 更大的最大传输单位，因而更大的帧大小（特别是超长帧）将减少每个字节产生的网络堆栈开销。 当 MTU 从1514更改为9000时，测量了20% 的 TCP 吞吐量增加。 另外，由于从网络堆栈到网络驱动程序的调用次数较少，因此获取了 CPU 使用率的明显降低。

 

 





