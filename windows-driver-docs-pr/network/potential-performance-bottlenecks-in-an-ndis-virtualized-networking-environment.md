---
title: 虚拟化网络环境中的性能瓶颈
description: NDIS 虚拟化网络环境中的潜在性能瓶颈
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 8afef1f932eaa1d27f50c93f51c441c3ead5e8dd
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96808587"
---
# <a name="potential-performance-bottlenecks-in-an-ndis-virtualized-networking-environment"></a>NDIS 虚拟化网络环境中的潜在性能瓶颈





在支持设备共享的网络环境中，将在每个 Hyper-v 子分区中公开具有其自己的媒体访问控制 (MAC) 地址的虚拟接口。 这些虚拟接口使用底层虚拟机总线 (VMBus) 连接到在 hyper-v 父分区的管理操作系统中运行的 Hyper-v 可扩展交换机模块上的端口。 可扩展交换机通过向底层共享网络适配器发出发送请求，从不同的分区传输所有传出帧。

物理网络适配器表示其在管理操作系统中接收到可扩展交换机的所有传入帧。 可扩展交换机使用目标 MAC 地址将指示的传入帧分配给虚拟网络适配器。 对于每个子分区，必须从管理操作系统中的网络适配器缓冲区将传入帧复制到从关联子分区预分配的辅助缓冲区。 通知将发送到每个包含挂起帧的虚拟接口。 每个子分区中的虚拟接口指示传入帧到过量传输驱动程序。 标识应用程序后，传输驱动程序会将数据负载从辅助缓冲区复制到应用程序缓冲区。

因此，在虚拟化环境中，会将传入的收到帧从网络适配器缓冲区复制两次，并将其复制到从子分区的目标内存地址空间分配的临时缓冲区，然后再从该临时缓冲区复制到应用程序缓冲区。 管理操作系统中的可扩展交换机必须使用 CPU 周期来分析传入帧，并基于其目标 MAC 地址将它们放在单独的队列中。

下图显示了在虚拟化环境中接收处理的性能瓶颈。

![说明虚拟化环境中的接收处理性能瓶颈的示意图](images/vmqsyntheticpaths.png)

上图中的性能问题包括：

-   必须检查每个传入数据包，以标识目标虚拟网络适配器。

-   必须将接收的数据从父分区的内存地址空间复制到子分区的内存地址空间。

-   中断和 Dpc 缺乏并发性。

### <a name="overcoming-performance-bottlenecks-with-vmq"></a>通过 VMQ 克服性能瓶颈

若要解决性能问题，虚拟机队列 (VMQ) 接口允许：

-   一个网络适配器，通过在硬件中实现 MAC 地址筛选来确定目标子分区。

-   一个网络适配器，使用 DMA 将接收的数据包直接传输到子分区的内存地址空间。

-   一个微型端口驱动程序，通过指示在不同 Cpu 上的不同子分区接收的数据包，提供中断和 DPC 并发性。

**注意**  从外部网络接收的数据包仍必须由管理操作系统通过 VMBus 转发到来宾操作系统。

 

有关 VMQ 接口的详细信息，请参阅 [ (VMQ) 虚拟机队列 ](virtual-machine-queue--vmq-.md)。

### <a name="overcoming-performance-bottlenecks-with-sr-iov"></a>通过 SR-IOV 克服性能瓶颈

单个根 i/o 虚拟化 (SR-IOV) 接口提供了基于标准的基础，可在多个子分区之间有效地共享 PCI Express (PCIe) 设备。 物理 i/o 资源是在 PCIe 设备中虚拟化的，因此每个设备都提供多个称为 *虚拟函数* (VFs) 的虚拟 i/o 接口。 管理操作系统可以配置设备上的每个 VF，并将其分配给特定的子分区。

VF 作为硬件设备公开给子分区。 所有数据数据包直接在来宾操作系统与 VF 之间流动。 这消除了管理操作系统和子分区之间的软件路径用于数据流量。 它通过为每个子分区提供独立的内存空间、中断和 DMA 流，绕过管理操作系统在数据移动中的干预。 通过使用连接到 VF 的内部端口，将帧发送到外部网络，方法是使用设备的物理端口或其他子分区。

在所有情况下，SR-IOV 接口都无需对数据路径中的管理操作系统进行任何干预。 因此，SR-IOV 接口提供以下内容：

-   提高了 i/o 吞吐量并降低了 CPU 利用率。

-   延迟较低。

-   改进了可伸缩性。

有关 SR-IOV 接口的详细信息，请参阅 [单一根 I/o 虚拟化 (sr-iov) ](single-root-i-o-virtualization--sr-iov-.md)。

 

 





