---
title: 为了节能而对传感器数据进行批处理
description: 本主题介绍了在 Windows 10 中实现传感器数据批处理的传感器类扩展和传感器驱动程序之间需要的接口。
ms.date: 07/20/2018
ms.localizationpriority: medium
ms.openlocfilehash: 7564e1dfa74dbaa74d1b9f25ab207470e1f05cd9
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96812257"
---
# <a name="sensor-data-batching-for-power-savings"></a>为了节能而对传感器数据进行批处理


本主题介绍了在 Windows 10 中实现传感器数据批处理的传感器类扩展和传感器驱动程序之间需要的接口。

## <a name="introduction"></a>简介


实现数据批处理的传感器驱动程序允许应用程序处理器节省电能，因为处理器接收并处理传感器数据的频率更低。 在这种情况下，传感器驱动程序会缓冲传感器硬件中的传感器数据样本，然后将其成批传输到传感器类扩展。 若要支持批处理，你必须提供一个 UMDF 2.0 通用传感器驱动程序，该驱动程序将实现所需的接口。

**批处理延迟**

批处理延迟定义为：在将数据采样交付给传感器类扩展之前，该传感器可以在该时间段内缓冲数据样本的最长时间。 当驱动程序通过驱动程序传送传感器事件时，传感器数据批处理 "计划" 会根据以下关系图中所示的批处理滞后时间值进行。

![此图显示了使用正常数据传递的 n 个数据样本的集合和发送顺序。](images/data-batching1.png)

如果驱动程序未实现数据批处理，驱动程序只需收集传感器数据并将其发送到可用。 例如，若要发送 N 个数据示例，驱动程序将启动数据示例的收集和发送。

![此关系图显示了 n 个数据示例的收集和发送顺序，并使用批处理数据传递中的两个批次。](images/data-batching2.png)

对于实现数据批处理的驱动程序，数据收集和传递顺序按批次执行，如前面的关系图中所示。 批处理滞后时间值由传感器类扩展指定。 因此，当传感器硬件必须收集和传输 N 个数据样本时，传感器驱动程序可以将进程拆分为两个批。 N 个数据样本的前半部分将在时间间隔后发送，该时间间隔等于批处理滞后时间。 然后，在另一个批处理延迟时间间隔后，将发送第二一半数据样本，并与正常传递方法所要求的 N 次传输进行合计。

## <a name="sensor-properties"></a>传感器属性


除了所需的常见传感器属性和枚举属性，支持数据批处理的驱动程序还必须报告以下属性：

-   PKEY \_ 传感器 \_ FifoReservedSize \_ 示例

-   PKEY \_ 传感器 \_ FifoMaxSize \_ 示例

-   PKEY \_ 传感器 \_ WakeCapable

有关详细信息，请参阅 [常见传感器属性](common-sensor-properties.md) 和 [枚举属性](enumeration-properties.md)。

如果传感器硬件子系统具有唤醒功能，则应确保它提前启动唤醒，以避免缓冲区溢出。

## <a name="optional-ddsi-functions-for-data-batching"></a>用于数据批处理的可选 DDSI 函数


设备驱动程序软件接口 (DDSI) 函数是驱动程序和类扩展之间的接口。 为了支持数据批处理，驱动程序必须实现以下 DDSI 函数，以便传感器类扩展可以设置批处理滞后时间。

-   [EvtSensorSetBatchLatency](/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config) 这是一个为指定传感器设置批处理延迟的回调函数。 驱动程序应将批处理延迟设置为小于或等于 *BatchLatencyMs* 参数的值，具体取决于缓冲区的可用性。

驱动程序还必须实现所有必需的 DDSI 函数。 有关详细信息，请参阅 [_SENSOR_CONTROLLER_CONFIG 结构](/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config)。

对于传感器类扩展指定批处理延迟，这是可选的。 所有传感器的默认批处理延迟为零 (0) ，用于指示不会对样本进行批处理。 仅当类扩展调用 **EvtSensorSetBatchLatency** 来设置批处理延迟值时，才会以批处理形式传递传感器示例。 否则，示例将按定期的数据间隔速率交付。

传感器类扩展可以随时调用 **EvtSensorSetBatchLatency** 来更改批处理滞后时间值。 特别是，当指定的传感器已经处于活动状态且正在运行时，可以调用此函数，这不会导致事件丢失。 传感器驱动程序应立即收集并开始交付最新批的示例，)  (。 驱动程序不应超过类扩展指定的批处理延迟。

需要特别注意的是，由于数据批处理，传感器数据传递方法和事件不会有任何变化。 当批处理延迟过期时，驱动程序将重复调用 SensorsCxSensorDataReady，以便一次传递一个所有缓冲数据样本。 数据示例附带其时间戳 (包含在其关联的 PKEY \_ SensorData \_ Timestamp 数据字段中，) 指示每个采样的时间。 有关 PKEY \_ SensorData 时间戳的详细信息 \_ ，请参阅 [通用数据字段](common-data-fields.md)。

## <a name="batch-latency-and-data-rate-relationship"></a>批处理延迟和数据速率关系


批处理延迟和数据速率相关，如下所示：

![批处理延迟值的公式（以毫秒为单位）。](images/batch-formula.png)

其中， *SensorBatching \_ MaxSize \_ Bytes* 是批处理传感器数据缓冲区的最大大小。 如果传感器是加速感应器，则建议使用足以容纳250或更多示例的硬件缓冲区。 数据速率以毫秒为单位表示，这是传输一个数据示例所用的时间长度。 传感器硬件必须存储在批中的样本数与数据速率成反比。 数据速率越小，存储给定批处理延迟值的批处理样本所需的示例缓冲区就越大。 在前面的公式中，批处理延迟由 *BatchLatencyMs* 表示，数据速率由 *DataRateMs* 表示。 而且，如果 *BatchLatencyMs* 和 *DataRateMs* 的组合产生大于 *SensorBatching \_ MaxSize \_ 字节* 的缓冲区大小，则 **EvtSensorSetBatchLatency** 和 [EvtSensorSetDataInterval](/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config) 会将批处理延迟设置为上一个公式显示的值。

如果调用方指定的 *BatchLatencyMs* 值小于 *DataRateMs*，则在不进行缓冲的情况下传递数据。

## <a name="batching-with-data-thresholds"></a>带有数据阈值的批处理


实现数据批处理的传感器驱动程序可以使用 [EvtSensorSetDataThresholds](/windows-hardware/drivers/ddi/sensorscx/ns-sensorscx-_sensor_controller_config) 来设置非零数据阈值。 在这种情况下，当当前读数与最后一个读数之间的数据值之差超出了使用 **EvtSensorSetDataThresholds** 设置的数据阈值时，将调用数据收集、批处理和传递进程。 因此，将数据批处理与数据阈值结合使用，可使传感器驱动程序节省更多的能力。

当传感器类扩展和数据批处理设置非零数据阈值时，驱动程序应提供具有准确时间戳的批处理样本，并同时服从数据阈值。 如果传感器硬件本身无法在强制数据阈值时保持准确的时间戳，则它可以收集样本，而不会强制数据阈值。 但是，在这种情况下，驱动程序应在将其传递给传感器类扩展之前，筛选出不满足当前数据阈值设置的示例。

## <a name="sequence-diagram-examples"></a>序列图示例


下面的序列图显示在 [用于数据批处理的可选 DDSI 函数](#optional-ddsi-functions-for-data-batching)中提到的可选数据批处理 DDSI 函数的用法。 我们可以根据需要添加更多序列图，以基于合作伙伴反馈阐明方案。

**方案 1**

在此方案中，传感器类扩展在启动传感器之前设置批处理延迟和数据间隔。 传感器开始后会定期提供批次，同时遵从设置的属性。

![显示在启动传感器之前类扩展设置批处理延迟和数据间隔的方案的序列图。](images/batch-scenario1.png)

**方案 2**

在此方案中，传感器类扩展在启动传感器之前设置批处理延迟、数据间隔和数据阈值。 传感器开始后会定期提供批次，同时遵从设置的属性。 请注意，驱动程序不应传递批处理，除非存在满足数据阈值的示例，需要在指定的批处理延迟内发送这些值。

![序列图显示在启动传感器之前，类扩展设置批处理延迟、数据间隔和数据阈值的情况。](images/batch-scenario2.png)

**场景 3**

在此方案中，传感器类扩展在启动传感器之前设置批处理延迟和数据间隔。 传感器开始后会定期提供批次，同时遵从设置属性。 传感器类扩展在传感器运行时更改批处理延迟和数据间隔，驱动程序会立即根据新值开始交付样本，而不会在运行时丢失任何数据样本。

![显示类扩展在启动传感器之前设置批处理延迟、数据间隔的情况的序列图。 关系图还显示传感器如何继续响应设置中的更改，同时处理数据传输。](images/batch-scenario3.png)

## <a name="data-batching-hardware-configurations"></a>数据批处理硬件配置


传感器数据必须在传感器硬件中进行批处理，而不需要应用程序处理器。 这样，在对数据进行批处理以节省电能时，处理器将进入睡眠状态。 下图显示了基于传感器硬件的数据批处理的可能配置。

-   **配置 1**： FIFO 缓冲区是在直接连接到应用程序处理器的传感器组件中实现的。

-   **配置 2**： FIFO 缓冲区是在传感器组件连接到的低功率传感器硬件核心中实现的。 在这种情况下，可在多个传感器之间共享 FIFO 缓冲区，甚至可以与非传感器组件共享，具体取决于传感器核心设计。 低功率传感器核心正在连接到应用程序处理器，并可集成到 SoC。 或者，它可能是外部组件。

-   **配置 3**：在传感器组件上实现 FIFO 缓冲区。 传感器组件连接到连接到应用程序处理器的低功率传感器核心。 传感器组件可以集成到 SoC 中，也可以是外部组件。

-   **配置 4**： FIFO 缓冲区是在传感器组件和低功率传感器核心上实现的。 传感器组件连接到电源传感器核心，而后者又连接到应用程序处理器。 传感器组件可以集成到 SoC 中，也可以是外部组件。 值得注意的是，可以使用传感器核心来扩展太浅的 FIFO。

要注意的重要一点是，可在传感器核心硬件或传感器硬件上实现 FIFO。 该驱动程序将为操作系统提取此的摘要，并通过 DDSI 显示统一的接口。

下图说明了前面的列表中所述的不同配置。

![显示用于承载批处理传感器数据的可能硬件配置的关系图。](images/sensor-batch-hw.png)

**Buffer-硬件中的完整行为**

在正常情况下，驱动程序应该每隔一段时间间隔至少读取一次硬件缓冲区 *，以* 确保不会丢弃或丢失任何数据。 当硬件 FIFO 缓冲区填满时，它应换行并表现为类似于循环缓冲区的覆盖旧事件。

