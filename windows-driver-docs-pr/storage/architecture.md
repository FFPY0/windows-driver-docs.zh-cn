---
title: 体系结构
description: 体系结构
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 109c1d57d09aa3f2c339a3ba16daf3ec4f60c441
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96804802"
---
# <a name="architecture"></a>体系结构


在讨论用于1667兼容大容量存储设备的枚举和发现过程之前，请务必了解之前对于旧 USB 大容量存储设备的进程。

当 USB 大容量存储设备连接到 Windows XP 或 Vista 主机系统时，将安装并加载内核模式驱动程序 USBStor。 此驱动程序会创建多个 (PDOs 的磁盘物理设备对象) 等于设备上) 存在的逻辑 (单元数。 图1说明了单 LUN USB 闪存设备 (UFD) 的驱动程序堆栈。

![图1：旧 usb 大容量存储的驱动程序堆栈](images/enhancedstorage-1.png)

当设备连接到系统时，可通过磁盘 PDO 表示的磁盘设备访问位于 LUN 0 的数据存储媒体。 PartMgr 识别媒体上存储的分区信息，而 VolMgr 使用此信息创建一个或多个代表媒体上的逻辑分区的卷 PDOs。 检查每个卷以确定文件系统类型，然后为该卷装载相应的文件系统。 然后，应用程序通过系统 API 处理此装入的卷，使用常见的文件路径命名法，其中包含 DOS 驱动器号 (例如 *E： \\ myfile.txt*) 。

旧式和1667大容量存储设备之间的一个主要区别是，在授权之前，1667 ACT 的用户数据部分完全无法访问。 这与旧式大容量存储与不可移动介质的行为相比较。 对于具有可移动媒体的已连接设备，必须可访问存储数据。 如果 Windows OS 平台及其助理应用程序生态系统的设备错误，则认为任何与此相反的行为。 连接性意味着可访问，因此添加连接但不可访问的设备将公开此基础假设，并通过以下方式打破用户体验：

-   尝试从命令提示符窗口访问驱动器将导致对话框报告 "0xC0000013"，设备中不存在介质。

-   尽管驱动器不可访问，但它似乎不是由已装载的文件系统真正支持的，只是为了为初始化、分区和格式化) 提供目标 (。 在 shell 或打开/保存通用对话框中单击此卷的图标会生成以下 "插入磁盘" 对话框。 这不是用户可操作的用于连接的 UFD 的指令。

-   由 GetOpenFileName 和 GetSaveFileName 例程调用的应用程序导致的所有 " **打开** " 和 " **另存为** " 对话框都会导致显示同一个对话框。

-   由于连接但无法访问存储，使用 Win32 文件系统 Api 的任何应用程序都可能遇到意外行为。

-   出现启动错误日志条目，因为报告 RMB = 0 的未经身份验证的设备出现访问问题。

-   Shell 自动播放假定连接时可以立即访问驱动器。 自动播放并不用于适应在身份验证成功后只能访问驱动器的情况。 此类行为从普通 shell 大容量存储设备体验出发。

因此，为了避免混淆错误对话框和显示应用程序错误，将完全暂停对系统的卷的显示，直到通过1667身份验证授予了对相应操作的授权访问权限。

在图1中，USBStor 会为给定 ACT 上存在的每种类型的接收器创建新的 PDO。 图中显示了密码和证书身份验证接收器。 每个接收器都接收到唯一的 PDO，其中加载了相应的接收器驱动程序。 用户模式授权过程会为接收器 PDO 创建一个句柄，以便与设备通信，以便进行身份验证。 此时，设备还没有将卷枚举到系统;因此，与不可访问的存储目标没有混淆。 只有1667思洛接程序是可访问的，并且这些函数使设备进入可访问 ACT 用户的基础用户数据的状态。 为了简单明了，会显示一个具有单个操作的设备，但当设备上有多个操作时，将应用相同的原则。

图2和3显示了在 1667 UFD 首次连接到对操作进行身份验证的点，并向系统提供相应的卷后发生的两个步骤。

![图2： (步骤 1) 卷尚未显示。 仅身份验证接收器可见。](images/enhancedstorage-2.png)

磁盘 PDO 的创建已延迟，直到 ACT 进入访问授权状态。 身份验证成功完成且已授予访问权限后，USBStor 的 IOCTL 将发出信号，指示此授权状态更改。 USBStor 创建磁盘 PDO，并在此磁盘 PDO 顶部创建卷和文件系统驱动程序堆栈。 它的作用是使系统能够访问 ACT 数据。

![图3：授予 (步骤 2) 访问权限。 出现磁盘 pdo 和卷。](images/enhancedstorage-3.png)

设备是授予对其自身的访问权限的终极权限。 因此，如果授权状态在某种程度上 misjudged，则最差的结果是 USBStor 错误地为无法访问的行为创建了磁盘 PDO。 但是，根据设备提供的访问权限，这些数据保持安全。 延迟的磁盘 PDO 机制仅用于使用户体验更接近为旧版大容量存储设备提供的体验。 这并不是一种访问控制机制。 1667设备负责控制对的安全访问。

尽管图3是指内置密码和证书接收器驱动程序，但设计的可扩展性质还允许第三方供应商通过编写自己的驱动程序来参与身份验证和 ACT 授权工作流。 此外，还可能会发现和访问其功能与身份验证过程无关的泛型接收器。

IEEE 1667 规格允许设备上每个操作最多支持255个独立的接收器。 每个接收器不仅被标识为按序号，还会被标识为对应于该接收器的设备上特定函数实现的唯一接收器类型 ID。 对于图3中所示的设备，一个 ACT 同时公开证书和密码身份验证接收器。 第一个接收器是密码接收器，由密码接收器类型标识符表示。 第二个接收器被其他接收器类型标识符识别为证书接收器。 所有接收器类型标识符对于给定的接收器函数都是唯一的，由 IEEE 1667 管理主体颁发。

图4显示了具有多个接收器类型的设备，每种类型都由独立驱动程序寻址。

![图4：对于身份验证，供应商可以实现其他接收器。](images/enhancedstorage-4.png)

对于具有第三方身份验证的设备完全参与主机身份验证过程，供应商必须创建身份验证接收器驱动程序和身份验证客户端。 然后，ActiveStorage API 通过第三方提供的身份验证客户端进程（通过其驱动程序与第三方接收器进行通信）促进授权访问设备的过程。 ActiveStorage API 设计文档中介绍了 ActiveStorage API 和第三方身份验证客户端之间的接口。

除了第三方身份验证接收器以外，1667设备还可能会公开其他接收器。 可以部署第三方驱动程序以提供对给定接收器的访问，但这种驱动程序并不是绝对必要的。 供应商还可以选择在不使用接收器驱动程序的情况下与接收器通信;从而避免了完全部署驱动程序的需求。 第三方应用程序可能会将原始接收器命令直接发送到设备。

使用思洛接收器驱动程序与在 raw 模式下保留接收器的优点和缺点如下：

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">接收器驱动程序</th>
<th align="left">原始接收器</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p><strong>-</strong> 需要驱动程序部署。</p></td>
<td align="left"><p>+ 不需要驱动程序。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> 接收器驱动程序强制实施访问控制和事务控制。</p></td>
<td align="left"><p>- 只有通过 USBStor 提供的原始 i/o 提供的基本访问和事务控制。</p></td>
</tr>
<tr class="odd">
<td align="left"><p><strong>+</strong> 可以参与授权工作流和 UI。</p></td>
<td align="left"><p>- 不参与授权工作流和 UI。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> 上下文菜单操作谓词。</p></td>
<td align="left"><p>- 无上下文菜单操作谓词。</p></td>
</tr>
<tr class="odd">
<td align="left"><p><strong>+</strong> 接收器驱动程序中包含的转换/验证层。</p></td>
<td align="left"><p>- 直接发送到设备的原始命令。</p></td>
</tr>
<tr class="even">
<td align="left"><p><strong>+</strong> 接收器驱动程序为 multicommand 操作提供事务完整性。</p></td>
<td align="left"><p>- SPO 和 SPI 级别的基本事务完整性。</p></td>
</tr>
</tbody>
</table>

 

这些注意事项可能会告知供应商决定是否为其特定的接收器部署接收器驱动程序。 在某些情况下，除了无人驾驶，原始接收器访问足以满足单个客户端应用程序的要求，该客户端应用程序具有该接收器的操作的详细知识。 要使这种方法适合，供应商还必须确保从多个应用程序进行的同时访问不会给其设备带来问题。

在其他情况下，供应商可能希望提供对接收器的更多受限访问权限。 如果是这样，则需要更广泛的翻译和验证层。 另一种供应商要求是在上下文菜单上提供与驱动器卷对应的 shell drive 文件夹图标的自定义操作。 由于这些原因，供应商可能选择部署一个接收器驱动程序，以便在其设备上提供对专用接收器的访问权限。
