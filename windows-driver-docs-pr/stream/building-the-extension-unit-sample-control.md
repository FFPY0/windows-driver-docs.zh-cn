---
title: 生成扩展单元示例控件
description: 生成扩展单元示例控件
keywords:
- 扩展单元控制 WDK USB 视频类
- 控制 WDK USB 视频类
ms.date: 01/12/2021
ms.localizationpriority: medium
ms.openlocfilehash: c70c7ee3576867f5422f10482d4e05ddd25e7738
ms.sourcegitcommit: 10fecd036370f5eccb538004c5bec1fdd18c3275
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/12/2021
ms.locfileid: "98124087"
---
# <a name="building-the-extension-unit-sample-control"></a>生成扩展单元示例控件

您可以编译此部分中的代码以创建 UVC Extension Unit 示例控件。 生成此项目时，将创建一个 Microsoft ActiveX 控件，该控件可用于相应的应用程序以获取和设置扩展单元的属性。

若要使用该控件，需要实现特定扩展单元功能的硬件。 或者，可以使用 USB 模拟器。

使用以下步骤生成控件：

1. 安装以下包：

    - Microsoft Windows Server 2003 Service Pack 1 (SP1) 驱动程序开发工具包 (DDK) 
    - Microsoft DirectX 9.0 SDK Update (2 月 2005) 
    - Microsoft DirectX 9.0 2 2005 月版 SDK 额外版

2. 将以下主题中的示例代码复制到各个文件中。

    [UVC 扩展单元的示例接口](sample-interface-for-uvc-extension-units.md)

    [示例扩展单元插件 DLL](sample-extension-unit-plug-in-dll.md)

    [UVC 扩展单元的示例注册表项](sample-registry-entry-for-uvc-extension-units.md)

    [UVC 扩展单元的示例应用程序](sample-application-for-uvc-extension-units.md)

    [支持扩展单元的自动更新事件](supporting-autoupdate-events-with-extension-units.md)

    [提供 UVC INF 文件](providing-a-uvc-inf-file.md)

3. 创建源文件 *，* 如下所示：

    ```cpp
    TARGETNAME= uvcxuplgn
    TARGETTYPE= DYNLINK
    TARGETPATH= obj
    TARGETEXT=  ax

    DLLENTRY=_DllMainCRTStartup
    DLLBASE=0x10080000
    USE_MSVCRT=1

    USE_STATIC_ATL=1

    USER_INCLUDES= $(O)

    INCLUDES=

    SOURCES= interface.idl \
     uvcxuplgn.cpp \
             stdafx.cpp    \
             interface_i.c \
             vidcap_i.c    \
             xuproxy.cpp

    TARGETLIBS= \
            $(SDK_LIB_PATH)\kernel32.lib          \
            $(SDK_LIB_PATH)\user32.lib            \
            $(SDK_LIB_PATH)\gdi32.lib             \
            $(SDK_LIB_PATH)\advapi32.lib          \
            $(SDK_LIB_PATH)\comdlg32.lib          \
            $(SDK_LIB_PATH)\ole32.lib             \
            $(SDK_LIB_PATH)\oleaut32.lib          \
            $(SDK_LIB_PATH)\uuid.lib              \
            $(SDK_LIB_PATH)\comctl32.lib
    ```

4. 按如下所示创建 *生成* 文件文件：

    ```cpp
    #############################################################################
    #
    #       Copyright (C) Microsoft Corporation 1995
    #       All Rights Reserved.
    #
    #       MAKEFILE for WDM device driver kit
    #
    #############################################################################

    #
    # DO NOT EDIT THIS FILE!!!  Edit .\sources. if you want to add a new source
    # file to this component.  This file merely indirects to the real make file
    # that is shared by all the driver components of the Windows NT DDK
    #

    !if "$(WIN2K_DDKBUILD)" == ""
    !INCLUDE $(NTMAKEENV)\makefile.def
    !endif
    ```

5. 使用 Microsoft Windows SDK) 中包含的 *Guidgen.exe* 工具 (创建三个 guid：

    - 使用第一个 GUID 作为扩展单元的属性集 ID。 将基于 x 的 GUID 占位符替换为 *Xuproxy、Xusample、Xuplgin* 中的新 guid 和硬件级别的扩展单元描述符。
    - 使用第二个 GUID 作为扩展单元的 IID。 将基于 y 的 GUID 占位符替换为 *.idl* 和 *Xuplgin* 中的新 GUID。
    - 使用第三个 GUID 作为扩展单元 (clsid) 的类 GUID。 将基于 z 的 GUID 占位符替换为 *Xuplgin、Xuproxy* 和 Xusample 中的新 GUID *。*

6. 按如下所示创建 *Uvcxuplgn* ：

    ```cpp
    LIBRARY uvcxuplgn

    EXPORTS
        DllGetClassObject   PRIVATE
        DllCanUnloadNow     PRIVATE
        DllRegisterServer   PRIVATE
        DllUnregisterServer PRIVATE
    ```

7. 按如下所示创建 *Uvcxuplgn* ：

    ```cpp
    #include "stdafx.h"
    CComModule _Module;
    #include <initguid.h>
    #include "interface.h"
    #include "xuproxy.h"
    BEGIN_OBJECT_MAP(ObjectMap)
    OBJECT_ENTRY(CLSID_ExtensionUnit, CExtension)
    END_OBJECT_MAP()

    STDAPI DllRegisterServer(void)
    {
        return _Module.RegisterServer(FALSE, NULL);
    }

    STDAPI DllUnregisterServer(void)
    {
        return _Module.UnregisterServer();
    }

    EXTERN_C
    BOOL
    DllMain(
        HINSTANCE   hinst,
        DWORD       dwReason,
        LPVOID      lpReserved)
    {
        switch (dwReason) {
            case DLL_PROCESS_ATTACH:

                _Module.Init (ObjectMap, hinst);
                break;

            case DLL_PROCESS_DETACH:
                _Module.Term();
                break;
        }
        return TRUE;
    }

    extern "C" STDMETHODIMP DllCanUnloadNow(void)
    {
        return _Module.GetLockCount()==0 ? S_OK : S_FALSE;
    }

    extern "C" STDAPI DllGetClassObject(
        REFCLSID    rclsid,
        REFIID      riid,
        LPVOID      *ppv)
    {
        return _Module.GetClassObject(rclsid, riid, ppv);
    }
    ```

8. 按如下所示创建 *stdafx.h* ：

    ```cpp
    // stdafx.h : include file for standard system include files,
    //      or project specific include files that are used frequently,
    //      but are changed infrequently

    #if !defined(AFX_STDAFX_H__722DC775_FE6F_42FB_BED5_E1E299976D17__INCLUDED_)
    #define AFX_STDAFX_H__722DC775_FE6F_42FB_BED5_E1E299976D17__INCLUDED_

    #if _MSC_VER > 1000
    #pragma once
    #endif // _MSC_VER > 1000

    #define STRICT
    #ifndef _WIN32_WINNT
    #define _WIN32_WINNT 0x0400
    #endif
    #define _ATL_APARTMENT_THREADED

    #include <atlbase.h>
    //You may derive a class from CComModule and use it if you want to override
    //something, but do not change the name of _Module
    extern CComModule _Module;
    #include <atlcom.h>
    #include <atlctl.h>

    //{{AFX_INSERT_LOCATION}}
    // Microsoft Visual C++ will insert additional declarations immediately before the previous line.

    #endif // !defined(AFX_STDAFX_H__722DC775_FE6F_42FB_BED5_E1E299976D17__INCLUDED)
    ```

9. 按如下所示创建 *stdafx.h* ：

    ```cpp
    // stdafx.cpp : source file that includes just the standard includes
    //  stdafx.pch will be the pre-compiled header
    //  stdafx.obj will contain the pre-compiled type information

    #include "stdafx.h"

    #ifdef _ATL_STATIC_REGISTRY
    #include <statreg.h>
    #include <statreg.cpp>
    #endif

    #include <atlimpl.cpp>
    ```

10. 通过在 WDK 生成环境中调用 cZg 生成该示例。
