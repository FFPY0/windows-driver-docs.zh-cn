---
title: 使用 Avcstrm.sys
description: 使用 Avcstrm.sys
keywords:
- 筛选器驱动程序 WDK AV/C 流式处理
- AV/C WDK，流筛选器驱动程序
- 流筛选器驱动程序 WDK AV/C
- Avcstrm.sys 流筛选器驱动程序 WDK，关于 Avcstrm.sys 流式处理筛选器驱动程序
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 63b10d0d943f11ad8c2fdd50ca785d0801292f9d
ms.sourcegitcommit: 418e6617e2a695c9cb4b37b5b60e264760858acd
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2020
ms.locfileid: "96795801"
---
# <a name="using-avcstrmsys"></a>使用 Avcstrm.sys





AV/C 流式处理筛选器驱动程序 *Avcstrm.sys* 在其客户端子单位驱动程序创建数据流后提供服务。 可以对数据流进行分类以执行三个函数：数据流、时钟提供程序，以及获取和设置流属性或事件。 这三个函数是相互关联的，流状态 (停止、暂停或运行) 控制数据流的行为。

子单位驱动程序首先请求 *Avcstrm.sys* 使用给定的数据格式创建一个流。 此数据格式包含 IEC 61883-*x* 协议规范中使用的信号格式的定义。 数据格式可以是 SDDV 或 MPEG2TS。 61883协议定义了如何在1394总线上传输数据。 AV/C 流式处理筛选器驱动程序验证并缓存数据格式，从目标设备查询可用的同步资源，如插件信息，并为排队数据流式处理请求分配必要的资源。

**注意**  ：在 Windows XP Service Pack 2 (SP2) 之前， *Avcstrm.sys* 只能使用目标设备的第一个 (索引 0) 中插句柄来建立连接。 这限制了受限制的 AV/C 设备 (，因此，它们的驱动程序) 多个子单位同时支持多个流。 但是，在 Windows XP SP2 和更高版本中， *Avcstrm.sys* 已更改为自动选择 AV/C 设备的同步插件句柄（从最低索引开始），使设备能够同时支持多个流。
由于连接是从最低索引和向上连接进行的，因此，子单元的内部连接 AV/C 单元的同步插件必须遵循相同的顺序。 仅具有一个子单位的 AV/C 设备或只有一个同步插件的设备不受影响。

 

成功创建流后，将返回流上下文。 此上下文是指向包含当前流相关信息（如数据格式和流状态）的不透明结构的指针。

创建流后，子单位驱动程序可以开始发送流数据请求。 此请求将排队，并将分配单独的 IRP，并将其提交到 *61883.sys* ，以便接收数据或数据传输。 完成数据请求后，将调用完成例程。 此请求是异步的，因为数据传输由流状态和数据的可用性控制。

流数据请求到达时，流可以处于已暂停状态或运行状态。 按暂停的流状态建立同步连接。 然后， *Avcstrm.sys* 请求 *61883.sys* 分配带宽和同步通道（如有必要），然后转换为运行流状态。

转换为停止状态时将停止数据流。 AV/C 流式处理筛选器驱动程序将通过请求61883分离数据缓冲区来收回数据缓冲区的所有权。 这些数据缓冲区将完成，状态为 "已 \_ 取消"。

如果已终止已调度 IOCTL 的线程，可能需要在事件（例如意外设备删除或数据 IRP 取消）期间中止流。 过渡到停止状态时，AV/C 流式处理筛选器驱动程序将停止同步数据传输，但不会更改流状态。

作为筛选器驱动程序， *Avcstrm.sys* **仅使用 irp** \_ MJ \_ 内部 \_ 设备 \_ 控制和 i/o 控制 () ioctl AVCSTRM 类的代码来筛选和处理 i/o 请求数据包 (IRP) \_ \_ ，并将其他 irp 传递到更低堆栈。 根据请求，AV/C 流式处理筛选器驱动程序会从其客户端处理 IRP，然后创建一个或多个本地分配的 Irp，以从其较低的堆栈（61883或 AV/C 协议驱动程序）请求服务。 即使子源驱动程序中的 IRP 可以向更低堆栈发送请求，但在类驱动程序声明 IRP 的所有权时，创建不同的 IRP 会更安全。

AV/C 流式处理筛选器驱动程序设计为在61883和 AV/C 堆栈上使用内核流接口。 子单位驱动程序可以使用 AVStream 或 Stream 类接口。

在以下部分中，将讨论每个 AV/C 流式处理命令功能， (一些代码示例) 。 此代码示例来自基于流类的子源驱动程序。

 

 




